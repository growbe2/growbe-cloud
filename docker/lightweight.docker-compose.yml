version: '3'
services:
  mongo:
    image: mongo
    restart: always
    networks:
      - net
    ports:
      - '0.0.0.0:27018:27018'
    volumes:
      - mongo:/data/db
    environment:
      MONGO_INITDB_DATABASE: "growbe"
      MONGO_INITDB_ROOT_USERNAME: doadmin
      MONGO_INITDB_ROOT_PASSWORD: test
    command: mongod --port 27018
  broker:
    image: eclipse-mosquitto
    networks:
      - net
    ports:
      - '0.0.0.0:1883:1883'
      - '0.0.0.0:9001:9001'
    volumes:
      - type: bind
        source: './mosquito/mosquito.conf'
        target: '/mosquitto/config/mosquitto.conf'
  growbe-cloud:
    image: ghcr.io/growbe2/growbe-cloud/growbe-cloud:${VERSION}
    networks:
      - net
    depends_on:
        - pgsql
        - mongo
        - broker
        - sso
    ports:
      - '0.0.0.0:3000:3000'
    expose:
      - '3000'
    environment:
      PORT: 3000
      NMS_TOKEN: '12345678'
      NMS_API_USERNAME: 'testadmin'
      NMS_API_PASSWORD: '12345678'
      NMS_API_URL: http://nms:8000
      SSO_URL: 'http://sso:3001'
      DB_URL: 'postgres://test:test@pgsql:5432/defaultdb'
      MONGO_URL: 'mongodb://doadmin:test@mongo:27018/growbe?authSource=admin'
      MQTT_URL: 'mqtt://broker:1883'
      REVERSE_PROXY_URL: 'http://reverseproxy:3008'
      DEBUG: 'growbe:*'
      # sso settings
      SSO_SETTINGS: '{"publicCreation":true,"multiFactor":false,"accountValidation":true, "defaultRoles": []}'
      EMAIL_FROM: '"Growbe Cloud" <robot@growbe.ca>'
      EMAIL_USER: 'apikey'
      EMAIL_PASSWORD: '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'
      EMAIL_REDIRECT: https://cloud.dev.growbe.ca
      SMS_SID: ''
      SMS_TOKEN: ''
      SMS_NUMBER: ''
      OTP_SECRET: '12445431'
      JWT_SECRET: '2342tf'
      JWT_TTL: 9600
    command: node dist/migrate.js && node dist/growbe-cloud-full.js

volumes:
  mongo:
    driver: local

networks:
  net:
    driver: bridge
